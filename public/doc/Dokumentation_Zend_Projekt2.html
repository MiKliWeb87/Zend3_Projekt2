<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<h2> cmd Protokoll Zend Projekt 2 </h2>
	<p>
		<ul>
			<li>Ordner zf3_mirco_projekt2 angelegt</li>
			<li>Daten aus ZendframeworkCenter Kapitel 15_07 in Ordner kopiert(außer vendor) </li>
			<li>oder anlegen mit composer create-project MiKliWeb87/Zend3_Projekt2 /path/to/install </li>
		</ul>
	</p>

	<h3> Verzeichnis wechseln</h3>
	<p>
	A:\devhost><pre>cd zf3_mirco_projekt2</pre>
	</p>
	<p>
 	A:\devhost\zf3_mirco_projekt2><pre>composer install<br>
	</p>
	<p> In der projektname\config\autoload\local.php muss unter Windows der html purifier gesetzt werden:
	
	return [
	'html_purifier_config' => [
        'Cache.SerializerPath' => 'A:\devhost\zf3_mirco_projekt2\temp',
		],
	];
	</p>
	  

<!--
####Umbau der nicht ging
Unternehmen in travelcenter(Reisebüro) geändert
Das auslesen des Reisebüros funktionierte, jedoch bei den Annoncen wurden keine Bilder und der Ansprechpartner nicht 
ausgelesen, außerdem gab es Probleme beim anlegen eines neuen Auftrags, deren Fehler ich nicht beheben konnte, dies habe ich allerdings erst nach dem weiteren Umbau festgestellt...

nach Änderung der Datenbank von Job/Projekte in travel/shorttravel
gab es das Problem beim erstellen einer Annonce welches auch in der vorherigen Version mit Job/Projekte auftrat(siehe oben),
den Fehler konnte ich mangels Kenntnisse und Fehlerverweise auf den vendor Ordner nicht lösen

Nächster Schritt: Zurück zum Ursprung

#### Umbau der funktionierte
1. Umbau des Projektes von Job/Projekte zu Urlaub/Kurzurlaub
d.h. alle Dateien werden durchsucht nach Job bzw. Projekt und ersetzt durch Urlaub/Kurzurlaub
außerdem müssen alle Sprachdateien entsprechend geändert werden

2. Umbau des Unternehmens zu Holidaycenter(Reisebüro)

a)in Projektordner -> config -> application.config.php
die Module 
	'HolidaycenterBackend',
	'HolidaycenterModel',
hinzufügen

b) in der composer.json beim autoload die Pfade zu den neuen Modulen hinzufügen:
	"HolidaycenterModel\\": "module/HolidaycenterModel/src/",
	"HolidaycenterBackend\\": "module/HolidaycenterBackend/src/",

c) In module\Application\config\module.config.php &
	in module\AdvertFrontend\config\module.config.php &
	in module\UserFrontend\config\module.config.php
	die User Rolle "CompanyRole" ändern oder die Rolle "HolidaycenterRole" hinzufügen
	sowie die use 
	"use UserModel\Permissions\Role\HolidaycenterRole;"
	in allen 3 Dateien & in module\UserModel\src\Permissions\UserAcl.php
	einfügen

d) die Ordner "CompanyBackend" & "CompanyModel" kopieren und in 
	HolidaycenterModel & HolidaycenterBackend umbenennen

e) Alle Dateien & Ordner in diesen beiden Ordnern die "Company" im Namen tragen 
umbenennen in Holidaycenter bzw. holidaycenter(bei klein company)

f) In allen Dateien in den beiden neuen Ordnern die Wörter company, Company und COMPANY 
durch holidaycenter, Holidaycenter und HOLIDAYCENTER ersetzen

g) in module\Application\view\application\index\index.phtml
Company getter durch Holidaycenter getter ersetzt

h) In module\UserModel\config\user.config.php die roleOption
	'holidaycenter' => 'user_model_option_role_holidaycenter',
hinzugefügt
	in den User language dateien "holidaycenter" option role hinzugefügt
	
i) In module\UserModel\src\Entity\UserEntity.php
		die setRole() Funktion von company auf holidaycenter geändert
	& module\UserModel\src\Repository\UserRepository.php
		die Funktion createUserFromData() entsprechend company auf holidaycenter geändert

j) Die Datei module\UserModel\src\Permissions\Role\CompanyRole.php
	kopiert und in HolidaycenterRole.php geändert sowie deren Inhalt auf 
	holidaycenter angepasst

k) in module\UserModel\src\Permissions\UserAcl.php
$this->addRole(new HolidaycenterRole()); //neue Nutzerrolle
einfügen

l) in module\AdvertModel\src\Storage\Db\AdvertDbStorage.php
	company & Company durch holidaycenter & Holidaycenter ersetzen

m) In module\AdvertFrontend\view\advert-frontend\display\detail.phtml &
      module\AdvertFrontend\view\advert-frontend\display\index.phtml
	getCompany() durch GetHolidaycenter() ersetzen

n) In module\AdvertModel\src\Hydrator\AdvertHydrator.php & 
	  module\AdvertModel\src\Entity\AdvertEntity.php
	alle use bzw. Einträge die Company beinhalten zu Holidaycenter ändern(Groß-/KLeinschreibung beachten)

o) In den 3 Form Dateien 
	module\AdvertBackend\src\Form\AdvertForm.php &
	module\AdvertBackend\src\Form\AdvertFormFactory.php &
	module\AdvertBackend\src\Form\AdvertFormFactory.php
   müssen ebenfalls die company Einträge zu holidaycenter geändert werden
 
p) Im InputFilter Ordner die 3 Dateien
	module\AdvertModel\src\InputFilter\AdvertInputFilter.php &
	module\AdvertModel\src\InputFilter\AdvertInputFilterFactory.php &
	module\AdvertModel\src\InputFilter\AdvertInputFilterInterface.php
		ebenfalls nach Company u. company durchforsten und diese ändern
q) Im Repository Ordner von AdvertModel 
   muss nur die Datei 
		module\AdvertModel\src\Repository\AdvertRepository.php
   durchsucht und abgeändert werden
   
r) Im AdvertBackend view Ordner müssen die Dateien 
		module\AdvertBackend\view\advert-backend\display\index.phtml &
		module\AdvertBackend\view\advert-backend\display\show.phtml &
		module\AdvertBackend\view\advert-backend\modify\approve.phtml &
		module\AdvertBackend\view\advert-backend\modify\block.phtml &
		module\AdvertBackend\view\advert-backend\modify\delete.phtml &
		module\AdvertBackend\view\advert-backend\modify\edit.phtml
	nach Company durchsucht und geändert werden

Nach diesen Änderungen sollte auf der Startseite wieder alles funktionieren...
Auch die Seiten Annoncen und Reisebüro administrieren gehen. 
Einzig die Detail Seiten der Annoncen zeigen nicht alles an unter anderem die Logos und der 
der Ansprechpartner sowie die Email Adresse des Reisebüros. Warum? 
Eine kleine Minizahl macht einem einen Strich durch die Rechnung. 
Diese finden wir in 
	module\HolidaycenterModel\src\Hydrator\Strategy\HolidaycenterEntityStrategy.php
	und ist die Zahl beim substr() und zwar die "8" diese muss auf die Länge der 
	Ersetzung, im Holidaycenter Fall also 14 gesetzt werden(13 Buchstaben und den Unterstrich)
	danach funktioniert auch die join Abfrage im AdvertDbStorage wieder und die Logos 
	und email Adressen sind zu sehen. 

s) Nun können eventuell noch Änderungen an den language Dateien vorgenommen werden, 
falls dort noch Wörter ersetzt werden sollen 

2. Umbau des Projektes zum Reisebüro, erstellen der Möglichkeit eines Bilder Uploads
in den Annoncen 

a) Dateien suchen die relevant für den Upload sind bzw. die entsprechenden Dateien in den Annoncen(Advert) Dateien:
		AdvertForm.php
		AdvertFormInterface.php
		AdvertFormFactory.php
		AdvertEntity.php
		AdvertInputFilter.php
		module\AdvertBackend\config\module.config.php
		module\AdvertBackend\src\Controller\ModifyController.php
		module\AdvertModel\src\Filter\ImageFileUpload.php die eine Kopie der 
			LogoFileUpload.php ist, mit entsprechender Änderung der Namen.
		+ die Sprachdateien beim einfügen neuer Texte die übersetzt werden müssen.

b) In der Datenbank wird die neue Spalte image eingefügt oder die Datenbank mit folgendem Zusatz neu erstellt:
	`image` varchar(64) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
	
c) in der AdvertForm.php das Image Upload Feld vor dem Submit Button setzen:
	/**
		 * Bild Upload Feld NEU
		 */
		$this->add(
            [
                'type'       => File::class,
                'name'       => 'image',
                'attributes' => [
                    'class' => 'form-control-static',
                ],
                'options'    => [
                    'label' => 'advert_backend_label_image',
                ],
            ]
        );
	noch dazu die 4 use Einbindungen:
		use AdvertModel\Filter\ImageFileUpload; //NEU
		use TravelloFilter\Filter\StringToUrlSlug;//NEU
		use Zend\Filter\StaticFilter;//NEU
		use Zend\Form\Element\File; //NEU
	
	Anlegung der 2 Variablen:
		
	private $imageFilePath;
    private $imageFilePattern;
	
	sowie die beiden Funktionen:
		public function setImageFilePath($imageFilePath)
		{
			$this->imageFilePath = $imageFilePath;
		}
		public function setImageFilePattern($imageFilePattern)
		{
			$this->imageFilePattern = $imageFilePattern;
		}
	
	ganz nach unten zudem die addImageFileUploadFilter() Funktion:
	
		/**NEU
		 * Add image file upload filter to input filter
		 */
		public function addImageFileUploadFilter()
		{
			$nameValue = $this->get('location')->getValue() . rand(1,1000); //einzigartiger Name...erweitern?

			$targetFile = sprintf(
				$this->imageFilePattern,
				StaticFilter::execute($nameValue, StringToUrlSlug::class)
			);

			$imageFileUploadFilter = new ImageFileUpload(
				$this->imageFilePath, $targetFile
			);

			$this->getInputFilter()->get('image')->getFilterChain()->attach(
				$imageFileUploadFilter
			);
		}
	
	c2) In der AdvertFormInterface.php
		die Funktion addImageFileUploadFilter() für die AdvertForm.php hinzufügen:
		
		/**
		 * NEU Add Image file upload filter to input filter
		 */
		public function addImageFileUploadFilter();
		
	c3) in der AdvertBackend module.config.php wird der Pfad und die 
	Eigenschaft des Bildes festgelegt(png):
	
	'holidaycenter_admin' => [
        'image_file_path'    => PROJECT_ROOT . '/public',
        'image_file_pattern' => '/images/%s.png',
    ], //NEU Ordnerpfad und Endung für Bilder festlegen
	
d) In der AdvertFormFactory.php muss die Config der module.config gerufen 
werden(Zeile 64): 
	/** @var array $config */
        $moduleConfig = $container->get('Config'); //NEU

Vor dem Return der form werden dann noch die beiden config Funktionen
aufgerufen(Zeile 77/80): 

	$form->setImageFilePath(
            $moduleConfig['holidaycenter_admin']['image_file_path']
        );
        $form->setImageFilePattern(
            $moduleConfig['holidaycenter_admin']['image_file_pattern']
        );
		
e) In der AdvertEntity.php wird die Variable fürs Bild und die getter 
und setter fürs Bild gesetzt:
	
	 private $image; //NEU
	 
	public function getImage() //NEU
    {
        return $this->image;
    }

    public function setImage($image) //NEU
    {
        $this->image = trim($image);
    }

f) In der AdvertInputFilter.php werden die use EInbindungen 
	
	use Zend\InputFilter\FileInput; //NEU
	use Zend\Validator\File\ImageSize; //neu
	use Zend\Validator\File\MimeType; //neu

	und der Filter fürs Bild gesetzt, dazu muss in der Sprachdatei der entsprechende Text bzw. Übersetzung geschrieben werden(language Ordner von AdvertModel):
	
		//Filter für Bilder NEU
		$this->add(
            [
                'name'       => 'image',
                'type'       => FileInput::class,
                'required'   => false,
                'filters'    => [],
                'validators' => [
                    [
                        'name'    => MimeType::class,
                        'options' => [
                            'mimeType' => 'image/png,image/x-png,image/jpeg, image/jpg',
                            'message'  => 'advert_model_message_image_type',
                        ],
                    ],
                    [
                        'name'    => ImageSize::class,
                        'options' => [
                            'minWidth'  => 128,
                            'minHeight' => 128,
                            'maxWidth'  => 4096,
                            'maxHeight' => 4096,
                            'message'   => 'advert_model_message_image_size',
                        ],
                    ],
                ],
            ]
        );

g) In der module\AdvertBackend\src\Controller\ModifyController.php
werden in der if Anweisung(Zeile 140) die Daten des Bildes geholt
und der Filter aufgerufen: 

	if ($this->getRequest()->isPost()) 
		{
            //$this->advertForm->setData($this->params()->fromPost());
			$postData  = $this->params()->fromPost();	//NEU
			$filesData = $this->params()->fromFiles(); //NEU
			//NEU
            if (isset($filesData['image']) && $filesData['image']['size'] > 0) 
			{
                $postData = array_merge_recursive($postData, $filesData);
            }

            $this->advertForm->setData($postData); //NEU
            $this->advertForm->addImageFileUploadFilter(); //bis hier neu
			
	[...]

Dies waren die Umstellungen der Dateien die mit dem Bildupload zu tun hatten was 
das interne angeht. Als nächstes fehlen noch die Dateien für den User damit 
dieser das hochgeladene Bild auch sieht. Dies wird für den Admin genauso geschehen
wie für den normalen User. Für den normalen User wird das Bild zu der Annonce nur 
auf der Detail Seite angezeigt, nicht in der Übersicht oder der Startseite.
 
	Die Dateien sind folgende:
	
	für den Backend User(Admin):
	module\AdvertBackend\view\advert-backend\display\show.phtml
	module\AdvertBackend\view\advert-backend\modify\block.phtml
	module\AdvertBackend\view\advert-backend\modify\approve.phtml
	module\AdvertBackend\view\advert-backend\modify\delete.phtml
	
	für den normalen User: 
	module\AdvertFrontend\view\advert-frontend\display\detail.phtml
	
h) In den 4 Dateien für den BackendUser werden innerhalb des form Tags folgende 
Zeilen hinzugefügt: 

	<div class="form-group">
      <label class="col-sm-1 control-label">
        <?= $this->translate('advert_backend_label_image') ?>
      </label>
	  <?php if($advert->getImage() != null): //NEU?>
		<img src="<?= $advert->getImage()  ?>" style="width:300px; height:200px;">
		<?php else:?> 
		<p id="noImage"> <?= $this->translate('advert_backend_message_no_image');?> </p>
		<?php endif; ?>
    </div>

	Es wird nach dem setzen des Labels abgefragt ob ein Bild vorhanden ist und wenn 
	ja dieses ausgelesen. Wenn nicht soll anstelle des leeren Image Rahmens ein Text angezeigt werden.
	
i) in der detail.phtml für den Frontend User wird zusätzlich auf der Detailseite
ein Button unterm dem Bild mit eingebaut der das Bild in einem neuen Tab in Originalbildgröße
anzeigt: 
		<?php if($advert->getImage() != null): //NEU Wenn Bild da?>
		<img src="<?= $advert->getImage() //NEU ?>" style="width:300px; height:200px;"> 
		<div class="col-sm-9 form-control-static">  
			<a target="_blank" href="<?= $advert->getImage() ?>" 
			class="btn btn-default" role="button" style="float:left;">
			<?= $this->translate('advert_frontend_label_button')?></a><!--NEU -->
<!--	</div>
		<?php else: //Kein Bild vorhanden?> 
		<p id="noImage"> <?= $this->translate('advert_frontend_message_no_image');?> </p>
		<?php endif; ?>	
		</div>

		
		
Einbauen: ?
Hotelname?
Sterne?
Preis?
Anzahl Tage?
 -->



		
		

</body>
</html> 




